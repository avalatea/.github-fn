name: Build and deploy to staging

run-name: Build and Deploy ${{ github.ref_name }} to staging by @${{ github.actor }}

# Name of this file without the .yml extension
concurrency:
cancel-in-progress: true

on:
  push:
    tags:
      - "*"

jobs:
  build:
    uses: FiscalNote/fn-shared-github-actions/.github/workflows/de-build.yaml@v1.0.1
    with:
      # The name of the repo in ECR. If it is not there, create it.
      # https://us-east-1.console.aws.amazon.com/ecr/repositories?region=us-east-1
      ECR_REPO:
      DOCKERFILE_PATH:
      TAGS: |
        # Tag generated by github sha
        type=sha,format=long,prefix=sha-,priority=100

        # Tag generated when a git tag is created (usually via a release)
        type=semver,pattern={{version}}

        # Tagged as latest
        type=raw,value=latest,priority=50
    secrets: inherit

  deploy:
    needs: build
    uses: FiscalNote/fn-shared-github-actions/.github/workflows/de-deploy.yaml@v1.0.1
    with:
      ENVIORNMENT: staging
      # The name of the service in the ops-kubernetes repo
      # https://github.com/FiscalNote/fn-ops-kubernetes/tree/master/helm_vars/defaults
      SERVICE:
      TAG: ${{ github.ref_name }}
    secrets: inherit
